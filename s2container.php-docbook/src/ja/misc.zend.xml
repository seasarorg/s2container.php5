<sect1 id="misc.zend"><title>Zend_ControllerでS2Containerを使用する</title>
    <sect2><title>動作環境</title>
        <itemizedlist>
            <listitem>PHP-5.3.0</listitem>
            <listitem>Zend Framework v1.8.4</listitem>
            <listitem>s2container.php-2.0.1</listitem>
        </itemizedlist>
    </sect2>

    <sbr/>
    <sect2><title>プロジェクトの作成</title>
        <para>
            Zend_Tool_Frameworkを使用しプロジェクトディレクトリを作成します。その後、s2container.phpを利用するための設定を追加します。
                        次のSVNリポジトリに今回作成したプロジェクトディレクトリがあります。
        </para>

        <itemizedlist>
            <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/">https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/</ulink></listitem>
        </itemizedlist>
    </sect2>

  <sbr/>
  <sect2><title>S2Containerの設定</title>
    <para>
      Zend_Tool_Frameworkで作成したプロジェクトにs2container.phpを利用するための設定を追加します。
    </para>

       <blockquote><formalpara><title>s2.phpの作成</title><sbr/></formalpara>
            <para>
            s2container.phpの設定を行うs2.phpをapplication/configsディレクトリに作成します。
            </para>
            <itemizedlist>
                <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/configs/s2.php">application/configs/s2.php</ulink></listitem>
            </itemizedlist>
       </blockquote>

       <sbr/>
       <blockquote><formalpara><title>S2ActionHelperの作成</title><sbr/></formalpara>
            <para>
                            アクションメソッド内でS2Containerにアクセスするアクションヘルパーを作成します。
            </para>
            <itemizedlist>
                <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/library/Seasar/Zf/Controller/S2ActionHelper.php">library/Seasar/Zf/Controller/S2ActionHelper.php</ulink></listitem>
            </itemizedlist>
       </blockquote>

       <sbr/>
       <blockquote><formalpara><title>Bootstrap.phpの編集</title><sbr/></formalpara>
            <para>
                            アプリケーションのBootstrapでS2ActionHelperを利用する設定を行います。(_initActionHelperメソッド)
            </para>
            <itemizedlist>
                <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/Bootstrap.php">application/Bootstrap.php</ulink></listitem>
            </itemizedlist>
       </blockquote>

       <sbr/>
       <blockquote><formalpara><title>varディレクトリの作成</title><sbr/></formalpara>
            <para>
                            ログファイル、セッションファイル、キャッシュなどを保存するためのvarディレクトリを作成します。
            </para>
            <itemizedlist>
                <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/var/">var/</ulink></listitem>
            </itemizedlist>
       </blockquote>
  </sect2>

  <sbr/>
  <sect2><title>アクションメソッドでS2Containerを利用する</title>
    <para>
        アクションメソッド内でS2Containerのコンポーネントを利用する場合は、S2ActionHelper経由でS2Containerにアクセスします。
    </para>
      <itemizedlist>
        <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/controllers/IndexController.php">application/controllers/IndexController.php</ulink></listitem>
      </itemizedlist>
<programlisting continuation="restart" linenumbering="unnumbered"><![CDATA[
    public function cdListAction()
    {
        $this->view->dtos = $this->_helper->s2('Service_SampleService')->findAllCd();
    }
]]></programlisting>
    <para>
        <ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/services/SampleService.php">Service_SampleServiceクラス</ulink>をapplication/servicesディレクトリに作成します。
        Service_SampleServiceクラスには、<ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/models/DbTable/Cd.php">Model_DbTable_Cdクラス</ulink>へのセッターメソッドが定義されているので、Model_DbTable_CdクラスのインスタンスがS2Containerによって自動インジェクションされます。
        Model_DbTable_Cdクラスは<ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/var/db/">var/db/sqlite.db</ulink>にアクセスするZend_Db_Tableのモデルです。
    </para>

    <para>
    アクションメソッド内からS2Containerへのアクセスは、S2ActionHelperのプロパティ経由でもアクセスすることができます。プロパティとして指定した名前がコンポーネント名になります。
    </para>

      <itemizedlist>
        <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/controllers/IndexController.php">application/controllers/IndexController.php</ulink></listitem>
      </itemizedlist>
<programlisting continuation="restart" linenumbering="unnumbered"><![CDATA[
    public function cdList2Action()
    {
        $this->view->dtos = $this->_helper->s2->service2->findAllCd();
    }
]]></programlisting>

    <para>
    上記の場合は"service2"と名前の付いたコンポーネントがS2Containerから取り出されます。ただし、S2Containerからコンポーネント名でコンポーネントを取得する場合は、
    あらかじめS2Containerにコンポーネントが登録されている必要があります。S2ActionHelperは、各アクション毎にS2Containerを構築するための設定ファイルを読み込むことができます。
    設定ファイルは、モジュールディレクトリのdiconsディレクトリに、"コントローラ名/アクション名.php"というファイルです。上記の場合は、次のファイルがcdList2アクションの設定ファイルになります。
    </para>

    <itemizedlist>
        <listitem><ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/application/dicons/index/cd-list2.php">application/dicons/index/cd-list2.php</ulink></listitem>
    </itemizedlist>
  </sect2>

  <sbr/>
  <sect2><title>コンポーネントのUnitTest</title>
    <para>
      UnitTestはtestsディレクトリに作成します。
      <ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/tests/application/bootstrap.php">tests/application/bootstrap.php</ulink>で、Zend_Applicationのbootstrapメソッドを実行し、アプリケーション環境を構築します。
      Service_SampleServiceクラスのUnitTestは、<ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/tests/application/services/">tests/application/servicesディレクトリ</ulink>に
      <ulink url="https://www.seasar.org/svn/s2container.php5/trunk/s2zf184/tests/application/services/SampleServiceTest.php">SampleServiceTest.php</ulink>として作成します。
      Service_SampleServiceTestクラスでは、setUpメソッドでテスト対象のサービスコンポーネントをS2Contaienr経由で取得しています。
    </para>

<programlisting continuation="restart" linenumbering="unnumbered"><![CDATA[
    public function setUp() {
        s2app::init();
        $this->service = s2app::get('Service_SampleService');
    }
]]></programlisting>

    <para>
    UnitTestの実行結果は次のなります。
    </para>

<programlisting continuation="restart" linenumbering="unnumbered"><![CDATA[
% cd tests
% cat phpunit.xml
<phpunit bootstrap="application/bootstrap.php"/>
% phpunit application
PHPUnit 3.3.17 by Sebastian Bergmann.

....

Time: 0 seconds

OK (4 tests, 4 assertions)
%
]]></programlisting>

  </sect2>
</sect1>

