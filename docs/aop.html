<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja"><head>



<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Language" content="ja">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta name="keywords" content="Seasar2, S2Container, DI, AOP, Dependency Injection, Aspect Oriented Programming, The Seasar Foundation, OSS, オープンソースソフトウェア, Java, フレームワーク">
<meta name="description" content="私たちSeasarプロジェクトはオープンソースという仕組みの元、開発者のゆとりを実現できるプロダクトの開発と提供を通じて、ユーザと開発者とが共に喜びを分かち合える環境実現をお手伝いすることを目指し活動しています。 ">
<title>The Seasar Project - S2Container.PHP5</title>

<link rel="stylesheet" type="text/css" href="theme/main.css" media="screen,projection">
<link rel="stylesheet" type="text/css" href="theme/print.css" media="print"></head><body>

<div id="wrapper">

<div id="header">

<div class="line"><span class="hide">spacer</span></div>

<div id="logo">
<h1 id="h01" class="hide">The Seasar Project</h1>
<a href="http://www.seasar.org/">
<img src="images/seasar_logo_blue.gif" alt="The Seasar Project" height="180" width="390">
</a>
</div>

<div id="tool">
</div>

<div id="navi">
<p><font size="-1"><a href="index.html">S2Container.PHP5 ホーム</a> &raquo; ドキュメント &raquo; AOP</font></p>
</div>

</div><!-- header -->

<div id="contents_left">

<h2>メニュー</h2>

<h3>ドキュメント</h3>
<ul>
    <li><a href="setup.html">セットアップ</a></li>
    <li><a href="quickstart.html">クイックスタート</a></li>
    <li><a href="DIContainer.html">DIContainer</a></li>
    <li>AOP
        <font size="-2">
        <ul>
            <li><a href="#S2AOPReference">S2AOPリファレンス</a>
                <ul>
                    <li><a href="#AOPMakeFile">作成すべきファイル</a></li>
                    <li><a href="#AOPExplanationFile">設定ファイルの説明</a></li>
                    <li><a href="#AOPInterceptor">S2AOPで用意されているInterceptor</a>
<!--
                        <ul>
                            <li><a href="#TraceInterceptor">TraceInterceptor</a></li>
                            <li><a href="#ThrowsInterceptor">ThrowsInterceptor</a></li>
                            <li><a href="#MockInterceptor">MockInterceptor</a></li>
                            <li><a href="#DelegateInterceptor">DelegateInterceptor</a></li>
                            <li><a href="#PrototypeDelegateInterceptor">PrototypeDelegate Interceptor</a></li>
                            <li><a href="#InterceptorChain">InterceptorChain</a></li>
                            <li><a href="#OriginalInterceptor">独自実装によるInterceptor</a></li>
                        </ul>
-->
                    </li>
                    <li><a href="#AOPInterType">S2AOPで用意されているInterType</a>
<!--
                        <ul>
                            <li><a href="#PropertyInterType">PropertyInterType</a></li>
                            <li><a href="#SerializableInterType">SerializableInterType</a></li>
                            <li><a href="#InterTypeChain">InterTypeChain</a></li>
                            <li><a href="#OriginalInterType">独自実装によるInterType</a></li>
                        </ul>
-->
                    </li>
                    <li><a href="#nodicon">diconファイルを使用しないでアスペクトを組み込む方法</a></li>
                </ul>
            </li>
            <li><a href="#Example">Example</a>
                <ul>
                    <li><a href="#TraceInterceptorSample">TraceInterceptor</a></li>
                    <li><a href="#ThrowsInterceptorSample">ThrowsInterceptor</a></li>
                    <li><a href="#DelegateInterceptorSample">DelegateInterceptor</a></li>
                    <li><a href="#PrototypeDelegateInterceptorSample">PrototypeDelegate Interceptor</a></li>
                    <li><a href="#OriginalInterceptorSample">独自実装によるInterceptor</a></li>
                </ul>
            </li>
        </ul>
        </font>
    </li>
    <li><a href="extension.html">Extension</a></li>
    <li><a href="php.html">PHP式</a></li>
</ul>


</div><!-- contents_left -->

<div id="contents_center">

<div id="article">
<div class="section">
<h2 id="h02"><a name="#S2AOPReference">S2AOPリファレンス</a></h2>

<h3><a name="AOPMakeFile">作成すべきファイル</a></h3>
<p>
　S2AOPの設定はS2Containerの設定ファイル(diconファイル)で行います。
設定ファイルの配置場所はとくに指定がありませんが、通常「Crosscutting Concern」と同じ場所に配置するか、
設定を行うコンポーネントと同じ場所に配置します。
</p>

<h3><a name="AOPExplanationFile">設定ファイルの説明</a></h3>

<h4><a name="aspecTtag">aspectタグ（AOPを使用する場合は必須）</a></h4>

<p>
　アスペクトをコンポーネントに組み込みます。Interceptorの指定は、ボディでPHP式を使うか、
子タグでcomponentタグを使います。1つのコンポーネントに複数のアスペクトを組み込んだ場合はアスペクトの登録順に組み込まれ実行されます。
詳しい説明は<a href="#OriginalInterceptor">独自実装のInterceptor</a>を参照してください。
</p>

<h5>注意点</h5>
<ul>
<li>
aspectタグで指定されたコンポーネントは、コンテナの初期化時にコンテナから取得されます。
そのため、aspectタグで指定されたコンポーネントのinstance属性がprototypeだったとしても、
Interceptorのメソッドが呼び出される度に新しいインスタンスが作成されるわけではありません。
</li>
<li>Publicなメソッドにアスペクトを適用できます。</li>
<li>staticなメソッドにはアスペクトを適用できません。</li>
<li>pointcut属性を指定しない場合、実装しているインターフェースのすべてのメソッドが対象になります。すべてのメソッドを対象にするには、pointcut属性に".*"と指定します。</li>
<li>S2AOPでは実装上、メソッドを実装するクラス外部からの呼び出し時にのみアスペクトが適用されます。<br>
    ( $this-> でメソッドを呼び出す場合はアスペクトが適用されません。) <i>( 1.1 系 ) </i></li>
<li>finalなクラス、メソッドにはアスペクトを適用できません。<i>( 1.2 系 ) </i></li>
<li>メソッド名が、アンダーバーで始まる場合はアスペクトを適用できません。<i>( 1.2 系 ) </i></li>
<li>メソッド引数のデフォルト値に値を持つ配列が設定されている場合はアスペクトを適用できません。<br>
  ( public function hoge($a = array('year' => 2007)); など)<i> ( 1.2 系 ) </i></li>
</ul>


<h5>pointcut属性(任意)</h5>
<p>
　カンマ区切りで対象となるメソッド名を指定することができます。pointcutを指定しない場合は、
コンポーネントが実装しているインターフェースのすべてのメソッドが対象になります。
メソッド名には正規表現も使えます。
</p>

<h5>設定例</h5>
<p>
　pointcut 属性を指定してDateのgetTime()メソッドを対象とする場合以下のようになります。
</p>

<pre>&lt;?php
class Date {
    function Date() {}

    function getTime(){
        return '12:00:30';
    }

    function getDate(){
        return '25';
    }
}
?&gt;
</pre>

<pre>&lt;component class="Date"&gt;
    &lt;aspect pointcut="getTime"&gt;
        &lt;component class="S2Container_TraceInterceptor"/&gt;
    &lt;/aspect&gt;
&lt;/component&gt;
</pre>

正規表現を使ってDateクラスのpublicなメソッドすべてを対象としたい場合は、以下のように設定します。
<pre>&lt;component class="Date"&gt;
    &lt;aspect pointcut=".*"&gt;
        &lt;component class="S2Container_TraceInterceptor"/&gt;
    &lt;/aspect&gt;
&lt;/component&gt;
</pre>

<h4><a name="interTypeTag">interTypeタグ</a></h4>
<p>
　InterTypeをコンポーネントに組み込みます。InterTypeの指定は、ボディでPHP式を使うか、子タグでcomponentタグを使います。
※PHP式については <a href="php.html">PHP式</a>を参照してください。1つのコンポーネントに複数のInterTypeを組み込んだ場合は
InterTypeの登録順に組み込まれます。詳しい説明は<a href="#OriginalInterType">独自実装のInterType</a>を参照してください。
</p>

<h5>設定例</h5>

<pre>&lt;component class="Date"&gt;
    &lt;interType&gt;
        &lt;component class="S2Container_PropertyInterType"/&gt;
    &lt;/interType&gt;
&lt;/component&gt;
</pre>

<h3><a name="AOPInterceptor">S2AOPで用意されているInterceptor</a></h3>

<p>
　S2AOPでは、以下のInterceptorを用意しています。また独自のInterceptorを簡単に作成できるようになっています。
</p>

<h4><a name="TraceInterceptor">TraceInterceptor</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_TraceInterceptor
</p>

<h5>説明</h5>
<p>
　トレース処理を「Crosscutting Concern」として扱うためのInterceptorです。
DateクラスにTraceInterceptorを適用したdiconファイルは、以下のようになります。
対象とするメソッドはgetTime()とします。
</p>

<pre>&lt;component class="Date"&gt;
    &lt;aspect pointcut="getTime"&gt;
        &lt;component class="S2Container_TraceInterceptor"/&gt;
    &lt;/aspect&gt;
&lt;/component&gt;
</pre>

<p>
詳しい使用方法は<a href="#TraceInterceptorSample">Example : TraceInterceptor</a>を参照してください。
</p>

<h4><a name="ThrowsInterceptor">ThrowsInterceptor</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_ThrowsInterceptor
</p>

<h5>説明</h5>

<p>
　例外処理を「Crosscutting Concern」として扱うためのInterceptorです。
使用するにはThrowsInterceptorを継承し、function handleThrowable(Exception, S2Container_MethodInvocation)を実装するだけです。
詳しい使用方法は<a href="#ThrowsInterceptorSample">Example : ThrowsInterceptor</a>を参照してください。
</p>

<h4><a name="MockInterceptor">MockInterceptor</a></h4>

<h5>クラス名</h5>
<p>
　S2Container_MockInterceptor
</p>

<h5>説明</h5>

<p>
　Mockを使ったテストを簡単に行うためのInterceptorです。
詳しい説明はテスト技法の<a href="http://www.seasar.org/testtech.html">モックを作成するための設定</a>を参照してください。
</p>

<h4><a name="DelegateInterceptor">DelegateInterceptor</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_DelegateInterceptor
</p>

<h5>説明</h5>

<p>
　メソッド呼び出しを別のコンポーネントに委譲するためのInterceptorです。
使用方法はDelegateInterceptorのtargetプロパティに委譲したい相手を指定します。
委譲するときのメソッド名が異なる場合には、DeleateInterceptor#addMethodNameMap($methodName, $targetMethodName)で指定します。
例えば、bar()というメソッドをfoo->bar2()に委譲する場合、
DeleateInterceptor#setTarget(foo)，DeleateInterceptor#addMethodNameMap
("bar", "bar2")のように指定します。詳しい使用方法は<a href="#DelegateInterceptorSample">Example : DelegateInterceptor</a>を参照してください。
</p>

<h5>注意</h5>

<p>
　targetプロパティに指定されたコンポーネントは、コンテナの初期化時にコンテナから取得されます。
このため、targetプロパティに指定されたコンポーネントのinstance属性がprototypeであっても、
常に同じインスタンスが使われます。メソッド呼び出しの度に新しいインスタンスをコンテナから取得したい場合は
次のPrototypeDelegateInterceptorを使用してください。
</p>

<h4><a name="PrototypeDelegateInterceptor">PrototypeDelegateInterceptor</a></h4>

<h5>クラス名</h5>

<p>
　PrototypeDelegateInterceptor
</p>

<h5>説明</h5>

<p>
　メソッド呼び出しを別のコンポーネントに委譲するためのInterceptorです。
メソッド呼び出しの度にコンポーネントをコンテナから取得します。使用方法は
PrototypeDelegateInterceptorのtargetNameプロパティに委譲したい相手の名前を指定します。
委譲するときのメソッド名が異なる場合には、PrototypeDeleateInterceptor#addMethodNameMap($methodName, $targetMethodName)で指定します。
例えば、bar()というメソッドをfoo->bar2()に委譲する場合、
PrototypeDeleateInterceptor#setTarget(foo)，
PrototypeDeleateInterceptor#addMethodNameMap("bar","bar2")のように指定します。
詳しい使用方法は<a href="#PrototypeDelegateInterceptorSample">Example : PrototypeDelegateInterceptor</a>を参照してください。
</p>

<h4><a name="InterceptorChain">InterceptorChain</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_InterceptorChain
</p>

<h5>説明</h5>

<p>
　複数のInterceptorをグルーピング化し再利用しやすくします。複数のInterceptorの組み合わせを
複数コンポーネントに適用する場合は、InterceptorChainで複数のInterceptorを1つにまとめて、
各コンポーネントにはInterceptorChainを指定するようにするといいでしょう。
</p>

<pre>&lt;component name="interceptor1" .../&gt;
&lt;component name="interceptor2" .../&gt;
&lt;component name="interceptor3" .../&gt;<br>&lt;component name="chain" class="S2Container_InterceptorChain"&gt;<br>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor1&lt;/arg&gt;&lt;/initMethod&gt;<br>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor2&lt;/arg&gt;&lt;/initMethod&gt;<br>    &lt;initMethod name="add"&gt;&lt;arg&gt;interceptor3&lt;/arg&gt;&lt;/initMethod&gt;<br>&lt;/component&gt;
&lt;component ...&gt;
    &lt;aspect&gt;chain&lt;/aspect&gt;
&lt;/component&gt;
&lt;component ...&gt;
    &lt;aspect&gt;chain&lt;/aspect&gt;
&lt;/component&gt;</pre>

<h4><a name="OriginalInterceptor">独自実装によるInterceptor</a></h4>

<h5>説明</h5>

<p>
　独自にInterceptorを作成する場合は、次のインターフェースまたは、抽象クラスを実装します。
</p>

<dl>
    <dt style="text-indent: 1em;">MethodInterceptor</dt>
    <dt style="text-indent: 1em;">AbstractInterceptor</dt>
</dl>

<p>
どちらの場合も実装するメソッドは、以下のinvoke()メソッドの１つだけです。
</p>

<dl>
    <dt style="text-indent: 1em;">public function invoke(S2Container_MethodInvocation $methodInvocation)</dt>
</dl>

<p>
AbstractInterceptorは、MethodInterceptorをimplementsした抽象クラスです。
AbstractInterceptorには、Proxyオブジェクトを取得するcreateProxy()メソッドと
アスペクトを適用するクラスを取得するgetTargetClass()メソッドがあります。
アスペクトを適用したクラス名を必要とするInterceptor(例えば、ログ出力を行うInterceptor)を作成する場合は、
AbstractInterceptorを使用することで簡単にクラス名を取得することができます。
</p>

<dl>
    <dt style="text-indent: 1em;">public function createProxy($proxyClass)</dt>
    <dt style="text-indent: 1em;">protected function getTargetClass(S2Container_MethodInvocation $methodInvocation)</dt>
</dl>

<p>
MethodInvocationのgetThis()、getMethod()、getArguments()で対象となるオブジェクト、
メソッド、引数を取得できます。proceed()を呼び出すと実際のメソッドが呼び出され実行結果を取
得することができます。以下のような独自のInterceptorを作成したとします。
</p>

<h5>作成例</h5>

<pre>&lt;?php
class SampleInterceptor implements S2Container_MethodInterceptor {
    public function invoke(S2Container_MethodInvocation $invocation){

        print "Before \n";             <-- 呼ぶ前は Before

        $ret = $invocation->proceed();

        print "After \n";              <-- 呼んだ後は After

        return $ret;
    }
}
?&gt;
</pre>

<p>
MethodInvocation#proceed()を呼ぶ前と後で2分され、呼ぶ前は Beforeの個所を実行し、
呼んだ後はAfterの個所を実行します。1つのコンポーネントに複数のアスペクトが定義されている場合は、
以下のよう実行されます。
</p>

<ol>
    <li>Aspectの登録順にMethodInterceptorのbefore部分が実行されます。</li>
    <li>最後のMethodInterceptorのbefore部分を実行した後にコンポーネント自身のメソッドが呼び出されます。</li>
    <li>Aspectの登録の逆順にMethodInterceptorのafter部分が実行されます。</li>
</ol>

<p>
詳しい使用方法は<a href="#OriginalInterceptorSample">独自実装によるInterceptor</a>を参照してください。
</p>

<!---
InterType Document
--->
<h3><a name="AOPInterType">S2AOPで用意されているInterType</a></h3>

<p>
　S2AOPでは、以下のInterTypeを用意しています。また独自のInterTypeを作成できるようになっています。
</p>

<h4><a name="PropertyInterType">PropertyTraceInterType</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_PropertyInterType
</p>

<h5>説明</h5>

<p>
　フィールドに対するsetter / getterメソッドを追加するInterTypeです。
</p>

<h5>注意点</h5>

<p>
　privateやprotectedのフィールドに対するgetter / setterはフィールドのデフォルト値を参照できません。
<br/>
参照を伴うフィールドにはpublicにしてください。
</p>

<pre>&lt;component class="Hoge"&gt;
    &lt;interType&gt;
        &lt;component class="S2Container_PropertyInterType"/&gt;
    &lt;/interType&gt;
&lt;/component&gt;</pre>

<p>
以下のクラスには、フィールドhogeに対してsetHoge/getHoge、フィールドfooに対してsetFoo/getFooが生成されます。
</p>

<pre>&lt;?php
class Hoge {
    public $hoge;
    private $foo;
}
?&gt;</pre>

<h4><a name="SerializableInterType">SerializableInterType</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_SerializableInterType
</p>

<h5>説明</h5>

<p>
　serialize/unserializeメソッドを生成します。<br/>
SPLの<a href="http://www.php.net/~helly/php/ext/spl/interfaceSerializable.html">Serializable</a>インタフェースを
実装していない場合は自動的に実装します。
</p>

<pre>&lt;component class="Hoge"&gt;
    &lt;interType&gt;
        &lt;component class="S2Container_SerializableInterType"/&gt;
    &lt;/interType&gt;
&lt;/component&gt;</pre>

<h4><a name="InterTypeChain">InterTypeChain</a></h4>

<h5>クラス名</h5>

<p>
　S2Container_InterTypeChain
</p>

<h5>説明</h5>

<p>
　複数のInterTypeをグルーピング化し、再利用しやすくします。
複数のInterTypeの組み合わせを複数コンポーネントに適用する場合は、
InterTypeChainで複数のInterTypeを1つにまとめて、各コンポーネントにはInterTypeChainを指定するようにするといいでしょう。
</p>

<pre>&lt;component name="interType1" .../&gt;
&lt;component name="interType2" .../&gt;
&lt;component name="interType3" .../&gt;
&lt;component name="chain" class="S2Container_InterTypeChain"&gt;
    &lt;initMethod name="add"&gt;&lt;arg&gt;interType1&lt;/arg&gt;&lt;/initMethod&gt;
    &lt;initMethod name="add"&gt;&lt;arg&gt;interType2&lt;/arg&gt;&lt;/initMethod&gt;
    &lt;initMethod name="add"&gt;&lt;arg&gt;interType3&lt;/arg&gt;&lt;/initMethod&gt;
&lt;/component&gt;

&lt;component ...&gt;
    &lt;interType&gt;chain&lt;/interType&gt;
&lt;/component&gt;
&lt;component ...&gt;
    &lt;interType&gt;chain&lt;/interType&gt;
&lt;/component&gt;</pre>

<h4><a name="OriginalInterType">独自実装によるInterType</a></h4>

<h5>説明</h5>

<p>
　独自にInterTypeを作成する場合は、次のインターフェースまたは、抽象クラスを実装します。
</p>

<dl>
    <dt style="text-indent: 1em;">S2Container_InterType</dt>
    <dt style="text-indent: 1em;">S2Container_AbstractInterType</dt>
</dl>

<p>
S2Container_InterTypeを実装するクラスは、以下のメソッドを実装します。
</p>

<dl>
    <dt style="text-indent: 1em;">public function introduce(ReflectionClass $targetClass, $enhancedClass)</dt>
</dl>

<p>
targetClassはInterTypeが適用されるクラスです。enhancedClassはInterTypeを組み込むクラスで、
先に登録されているInterceptorやInterTypeが適用済みの場合もあります。</p>

<p>
S2Container_InterTypeは以下の定数を提供します。
</p>

<dl>
    <dt style="text-indent: 1em;">const PUBLIC_ = "public"</dt>
    <dt style="text-indent: 1em;">const PROTECTED_ = "protected"</dt>
    <dt style="text-indent: 1em;">const PRIVATE_ = "private"</dt>
    <dt style="text-indent: 1em;">const STATIC_ = "static"</dt>
    <dt style="text-indent: 1em;">const CONST_ = "const"</dt>
</dl>

<p>
これらの定数は以下に説明するS2Container_AbstractInterTypeを使用する場合にアクセス修飾子で使用します。
</p>

<p>
S2Container_AbstractInterTypeは、S2Container_InterTypeをimplementsした抽象クラスです。S2Container_AbstractInterTyeのサブクラスは次のメソッドを実装します。
</p>

<dl>
    <dt style="text-indent: 1em;">public function introduce(ReflectionClass $targetClass, $enhancedClassName)</dt>
</dl>

<p>
S2Container_AbstractInterTypeのサブクラスは、次のメソッドで必要なオブジェクトを取得することができます。
</p>

<dl>
    <dt style="text-indent: 1em;">protected function getTargetClass()</dt>
    <dt style="text-indent: 1em;">protected function getEnhancedClass()</dt>
    <dt style="text-indent: 1em;">protected function getEnhancedClassName()</dt>
</dl>

<p>
S2Container_AbstractInterTypeは、フィールドやメソッド，実装するインタフェースを追加するためのユーティリティメソッドを提供します。
以下はその一部です。
</p>

<dl>
    <dt style="text-indent: 1em;">protected function addInterface($className)</dt>
    <dt style="text-indent: 1em;">protected function addConstant($name, $value)</dt>
    <dt style="text-indent: 1em;">protected function addStaticProperty(array $modify, $name, $value = null)</dt>
    <dt style="text-indent: 1em;">protected function addProperty(array $modify, $name, $value = null)</dt>
    <dt style="text-indent: 1em;">protected function addStaticMethod(array $modify, $name, $src)</dt>
    <dt style="text-indent: 1em;">protected function addMethod(array $modify, $name, $src)</dt>
</dl>

<p>
詳しい使用方法は<a href="http://wiki.s2php5.jp/s2container.php5/intertype">wiki.s2php5.jpのintertype</a>を参照してください。
</p>

<!---
 /InterType Document
--->

<h3><a name="nodicon">diconファイルを使用しないでアスペクトを組み込む方法</a></h3>
<p>
　diconファイルの設定を行わずプログラム上でアスペクトを組み込むこともできます。
作成方法は次のようになります。
</p>

<ul>
    <li>PointcutImplのコンストラクタの引数で対象となるメソッド名を指定(複数可)します。
        クラスを指定することで、そのクラスが実装しているインターフェースのメソッドを
        すべて自動的に適用させることもできます。
    </li>
    <li>AspectImplのコンストラクタの第1引数にInterceptorを指定して、第2引数にPointcutImplで作成したPointcutを指定します。</li>
    <li>AopProxyFactoryのcreateメソッドで、対象オブジェクト、クラス名、AspectImplで作成したAspectの配列を指定します。</li>
</ul>

<p>
DateクラスにTraceInterceptorをプログラム上で適用する場合は、次のようになります。対象となるメソッドはgetTime()とします。
</p>

<pre>&lt;?php
require_once(dirname(__FILE__) . '/trace.inc.php');

$pointcut = new S2Container_PointcutImpl(array("getTime"));
$aspect = new S2Container_AspectImpl(new S2Container_TraceInterceptor(), $pointcut);
$proxy = S2Container_AopProxyFactory::create(new Date(),'Date', array($aspect));
$proxy->getTime();
?&gt;
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/traceinterceptor以下に用意されています。
</p>

<br>
</div>

<div class="section">
<h2 id="h02"><a name="Example">Example</a></h2>
<p>
　以下のサンプルを実行する場合は、<a href="setup.html">セットアップ</a>を行う必要があります。
</p>

<h3><a name="TraceInterceptorSample">TraceInterceptor</a></h3>

<p>
 TraceInterceptorを使用してDateクラスのgetTime()メソッドが呼ばれた場合にトレースを出力させましょう。作成するファイルは以下のとおりです。
</p>

<ul>
    <li type="circle">コンポーネントを定義するdiconファイル(Trace.dicon)</li>
    <li type="circle">設定が正しく行われているか確認する実行スクリプト(AopTraceClient.php)</li>
</ul>

<h5>diconファイルの作成</h5>
<ul>
    <li type="circle">TraceInterceptorをコンポーネント定義します。name属性をtraceInterceptorとします。</li>
    <li type="circle">Dateクラスのコンポーネントの定義します。pointcut属性にgetTime()メソッドを指定します。
                      aspectタグにtraceInterceptorを指定します。
    </li>
</ul>

<p>　Trace.dicon</p>
<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component name="traceInterceptor" class="S2Container_TraceInterceptor"/&gt;
    &lt;component class="Date"&gt;
        &lt;aspect pointcut="getTime"&gt;
            traceInterceptor
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</pre>

<h5>実行スクリプトの作成</h5>
<ul>
    <li type="circle">S2Container#create()メソッドの最初の引数に作成したdiconファイル(Trace.dicon)のパスを指定してコンテナを作成します。</li>
    <li type="circle">S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名
                    （Date)を指定してコンポーネントを取得します。
    </li>
    <li type="circle">トレースがAspectされるか確認するために取得したコンポーネントのDateのgetTime()メソッドを実行します。</li>
</ul>

<p>
　AopTraceClient.php
</p>

<pre>&lt;?php
require_once(dirname(__FILE__) . '/trace.inc.php');

$PATH = EXAMPLE_DIR . "/aop/traceinterceptor/Trace.dicon";

$container = S2ContainerFactory::create($PATH);
$date = $container->getComponent('Date');
$date->getTime();
?&gt;
</pre>

<h5>実行結果</h5>
<p>
　メソッドが呼ばれる前と後でトレースが出力されているのが確認できます。
</p>

<pre>% php AopTraceClient.php
BEGIN Date#getTime()
END   Date#getTime() : 12:00:30
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/traceinterceptor以下に用意されています。
</p>
<br>

<h3><a name="ThrowsInterceptorSample">ThrowsInterceptor</a></h3>

<p>
　(1) ThrowsInterceptorを使って、例外が発生した場合でも処理を続けられるようにしましょう。
作成するファイルは以下のようになります。
</p>

<ul>
    <li type="circle">Exceptionを発生させるクラス(Checker.class.php)</li>
    <li type="circle">ThrowsInterceptorを継承して作成するInterceptor(HandleThrowableInterceptor.class.php)</li>
    <li type="circle">コンポーネントの定義をするdiconファイル(Checker.dicon)</li>
    <li type="circle">設定が正しく行われているか確認する実行ファイル(AopCheckerClient.php)</li>
</ul>

<h5>例外を発生させるクラスの作成</h5>

<ul>
    <li type="circle">run()メソッドの引数がnullでは無い場合は、引数の文字をコンソールに出力します。</li>
    <li type="circle">引数がnullの場合は、Exceptionを発生させます。</li>
</ul>

<p>　Checker.class.php</p>

<pre>&lt;?php
class Checker {
    public function check($str) {
        if ($str != null) {
            print $str . "\n";
        } else {
            throw new Exception("null");
        }
    }
}
?&gt;
</pre>

<h5>ThrowsInterceptorを継承するInterceptorの作成</h5>

<ul>
    <li type="circle">ThrowsInterceptorを継承します。</li>
    <li type="circle">handleThrowable(Exception, S2Container_MethodInvocation)を実装します。</li>
</ul>

<p>　HandleThrowableInterceptor.class.php</p>

<pre>&lt;?php
class HandleThrowableInterceptor extends S2Container_ThrowsInterceptor {
    public function handleThrowable(Exception $t,
                                    S2Container_MethodInvocation $invocation){
    }
}
?&gt;
</pre>

<h5>diconファイルの作成</h5>

<ul>
    <li type="circle">作成したInterceptorをコンポーネント定義します。name属性をhandleThrowableInterceptorとします。</li>
    <li type="circle">例外を発生させるCheckerクラスのcheck()メソッドに作成したHandleThrowableInterceptorをアスペクトします。</li>
</ul>

<p>　Checker.dicon</p>

<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component name="handleThrowableInterceptor" class="HandleThrowableInterceptor"/&gt;
    &lt;component class="Checker"&gt;
        &lt;aspect pointcut="check"&gt;
            handleThrowableInterceptor
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</pre>

<h5>実行ファイルの作成</h5>

<ul>
    <li type="circle">S2Container#create()メソッドの第１引数に作成したdiconファイル(Checker.dicon)のパスを指定してコンテナを作成します。</li>
    <li type="circle">S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（Checker)を指定して取得します。</li>
    <li type="circle">Checker#check()メソッドの引数に"foo"の文字列を渡します。</li>
    <li type="circle">Checker#check()メソッドの引数にnullを渡して例外を発生させます。</li>
    <li type="circle">Checker#check()メソッドの引数に"hoge"の文字列を渡します。</li>
</ul>

<p>　AopCheckerClient.php</p>

<pre>&lt;?php
require_once(dirname(__FILE__) . '/throws.inc.php');

$PATH = EXAMPLE_DIR . "/aop/throwsinterceptor/Checker.dicon";
$container = S2ContainerFactory::create($PATH);
$checker = $container->getComponent('Checker');
try{
    $checker->check("foo");
}catch(Exception $e){
    print "Exception : " . $e->getMessage() . "\n";
}

try{
    $checker->check(null);
}catch(Exception $e){
    print "Exception : " . $e->getMessage() . "\n";
}

try{
    $checker->check("hoge");
}catch(Exception $e){
    print "Exception : " . $e->getMessage() . "\n";
}
?&gt;
</pre>

<h5>実行結果</h5>

<p>
　例外で処理が止まっていないことが確認できます。
</p>

<pre>% php AopCheckerClient.php
foo
hoge
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/throwsinterceptor以下に用意されています。
</p>
<br>


<p>
(2) 例外を別の例外に変換するInterceptorを作成して変換したメッセージを表示させましょう。
作成するInterceptorは、先ほどThrowsInterceptorを継承して作成したクラス(HandleThrowableInterceptor.class.php)
を応用して作成しましょう
</p>

<h5>例外を別の例外に変換するInterceptorの作成</h5>

<p>
　S2RuntimeExceptionを発生させてメッセージを変更します。
</p>

<pre>&lt;?php
class HandleThrowableInterceptor extends S2Container_ThrowsInterceptor {
    public function handleThrowable(Exception $t,
                                    S2Container_MethodInvocation $invocation){
        throw new S2Container_S2RuntimeException("ESSR0007", array("arg"));
    }
}
?&gt;
</pre>

<p>
先ほど作成した実行ファイルを使って実行します。
</p>

<h5>実行結果</h5>
<p>
　エラーメッセージが変わっているのが確認できます。
</p>

<pre>% php AopCheckerClient.php
foo
Exception : arg should not be null or empty
hoge
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/throwsinterceptor以下に用意されています。
</p>

<br>
<h3><a name="DelegateInterceptorSample">DelegateInterceptor</a></h3>

<p>
　S2AOPで用意されているDelegateInterceptorを使って、他のクラスのメソッドに委譲させましょう。
ここでは、インターフェースで抽象メソッドを作成して、抽象クラスと普通のクラスの両方にそのインターフェースを実装させます。
抽象クラスで実装したメソッドを普通のクラスで実装したメソッドに委譲させましょう。
作成するファイルは以下のとおりです。
</p>

<ul>
    <li type="circle">インターフェース(IBase.class.php)</li>
    <li type="circle">インターフェースを実装した抽象クラス(Dummy.class.php)</li>
    <li type="circle">インターフェースを実装したクラス(Substance.class.php)</li>
    <li type="circle">委譲を設定するdiconファイル(Delegate.dicon)</li>
    <li type="circle">設定が正しく行われているか確認する実行ファイル(AopDelegateClient.class.php)</li>
</ul>

<h5>インターフェースの作成</h5>

<ul>
    <li type="circle">抽象メソッドを作成します。</li>
</ul>

<p>
　IBase.class.php
</p>

<pre>&lt;?php
interface IBase {
    public function run();
}
?&gt;
</pre>

<h5>インターフェースを実装した抽象クラスの作成</h5>

<ul>
    <li type="circle">作成したインターフェースを実装します。</li>
</ul>

<p>　Dummy.class.php</p>

<pre>&lt;?php
abstract class Dummy implements IBase {
}
?&gt;
</pre>

<h5>インターフェースを実装したクラスの作成</h5>

<ul>
    <li type="circle">作成したインターフェースを実装します。</li>
    <li type="circle">実装したインタフェースの抽象メソッドの実装します。</li>
</ul>

<p>　Substance.class.php</p>

<pre>&lt;?php
class Substance implements IBase{
    public function run() {
        print __METHOD__ . " called.\n";
    }
}
?&gt;
</pre>

<h5>diconファイルの作成</h5>

<ul>
    <li type="circle">抽象クラス(Dummy)をコンポーネント定義します。</li>
    <li type="circle">DelegateInterceptorのコンポーネントをaspectタグに定義します。
                      DelegateInterceptor#setTarget()を使って委譲したい相手を指定します。
                      委譲したいクラスはSubstanceクラスなのでメソッド・インジェクションを使ってセットします。
    </li>
</ul>

<p>　Delegate.dicon</p>

<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component class="Dummy"&gt;
        &lt;aspect&gt;
            &lt;component class="S2Container_DelegateInterceptor"&gt;
                &lt;initMethod name="setTarget"&gt;
                    &lt;arg&gt;new Substance()&lt;/arg&gt;
                &lt;/initMethod&gt;
            &lt;/component&gt;
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;</pre>

<h5>実行ファイルの作成</h5>

<ul>
    <li type="circle">S2Container#create()メソッドの最初の引数に作成したdiconファイル(Delegate.dicon)のパスを指定してコンテナを作成します。</li>
    <li type="circle">S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（Dummy)を指定して取得します。</li>
    <li type="circle">コンテナから取得したIBase#run()メソッドを実行します。</li>
</ul>

<p>　AopDelegateCilent.php</p>

<pre>&lt;?php
require_once(dirname(__FILE__) . '/delegate.inc.php');
$PATH = EXAMPLE_DIR . "/aop/delegateinterceptor/Delegate.dicon";
$container = S2ContainerFactory::create($PATH);
$base = $container->getComponent('Dummy');
$base->run();
?&gt;
</pre>

<h5>実行結果</h5>

<p>
　コンソールに"Substance::run called."と表示されているのでDummy#run()がSubstance#run()に委譲されているのが確認できます。
</p>

<pre>% php AopDelegateCilent.php
Substance::run called.
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/delegateinterceptor以下に用意されています。
</p>

<br>
<h3><a name="PrototypeDelegateInterceptorSample">PrototypeDelegateInterceptor</a></h3>

<p>
　S2AOPで用意されているPrototypeDelegateInterceptorを使って、singletonのコンポーネントからprototypeのコンポーネントのメソッドに委譲させましょう。
ここでは、インターフェースで抽象メソッドを作成して、抽象クラス(singleton)と普通のクラス(prototype)の両方に
そのインターフェースを実装させます。抽象クラスで実装したメソッドを普通のクラスで実装したメソッドに委譲させましょう。
作成するファイルは以下のとおりです。
</p>

<ul>
    <li type="circle">インターフェース(IBase.class.php)</li>
    <li type="circle">インターフェースを実装したsingletonの抽象クラス(Dummy.class.php)</li>
    <li type="circle">インターフェースを実装したprototypeのクラス(Substance.class.php)</li>
    <li type="circle">委譲を設定するdiconファイル(Delegate.dicon)</li>
    <li type="circle">設定が正しく行われているか確認する実行ファイル(AopPrototypeDelegateClient.php)</li>
</ul>

<h5>インターフェースの作成</h5>

<ul>
    <li type="circle">抽象メソッドを作成します。</li>
</ul>

<p>　IBase.class.php</p>

<pre>&lt;?php
interface IBase {
    public abstract function run();
}
?&gt;
</pre>

<h5>インターフェースを実装した抽象クラスの作成</h5>

<ul>
    <li type="circle">作成したインターフェースを実装します。</li>
</ul>

<p>　Dummy.class.php</p>

<pre>&lt;?php
abstract class Dummy implements IBase {
}
?&gt;
</pre>

<h5>インターフェースを実装したクラスの作成</h5>

<ul>
    <li type="circle">作成したインターフェースを実装します。</li>
    <li type="circle">実装したインタフェースの抽象メソッドの実装します。</li>
</ul>

<p>　Substance.class.php</p>

<pre>&lt;?php
class Substance implements IBase{
    private $sum = 0;

    public function run() {
        print "sum : " . $this->sum . "\n";
        $this->sum++;
    }
}
?&gt;
</pre>

<h5>diconファイルの作成</h5>

<ul>
    <li type="circle">抽象クラス(Dummy)をコンポーネント定義します。このコンポーネントはsingletonです。</li>
    <li type="circle">PrototypeDelegateInterceptorのコンポーネントをaspectタグに定義します。PrototypeDelegateInterceptorのtargetNameプロパティに委譲したい相手の名前("target")を指定します。</li>
    <li type="circle">委譲したいクラス(Substance)をコンポーネント定義します。このコンポーネントのinstance属性はprototypeです。</li>
</ul>

<p>　PrototypeDelegate.dicon</p>
<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    &lt;component class="Dummy"&gt;
        &lt;aspect&gt;
            &lt;component class="S2Container_PrototypeDelegateInterceptor"&gt;
                &lt;property name="targetName"&gt;"target"&lt;/property&gt;
            &lt;/component&gt;
        &lt;/aspect&gt;
    &lt;/component&gt;

    &lt;component name="target" class="Substance" instance="prototype"/&gt;
&lt;/components&gt;</pre>

<h5>実行ファイルの作成</h5>

<ul>
    <li type="circle">S2Container#create()メソッドの最初の引数に作成したdiconファイル(PrototypeDelegate.dicon)のパスを指定してコンテナを作成します。</li>
    <li type="circle">S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（Dummy)を指定して取得します。</li>
    <li type="circle">コンテナから取得したDummy#run()メソッドを繰り返し実行します。</li>
</ul>

<p>　AopPrototypeDelegateCilent.php</p>

<pre>&lt;?php
require_once(dirname(__FILE__) . '/prototype.inc.php');

$PATH = EXAMPLE_DIR . "/aop/prototypedelegateinterceptor/PrototypeDelegate.dicon";
$container = S2ContainerFactory::create($PATH);
$base = $container->getComponent('Dummy');
for ($i = 0; $i < 5; ++$i) {
   $base->run();
}
?&gt;
</pre>

<h5>実行結果</h5>

<p>
　コンソールに"sum : 0"と表示されているのでDummy#run()がSubstance#run()に委譲されているのが確認できます。
また、sumの値がすべて"0"となっていることから，run()メソッドを呼び出すたびに新しいSubstanceのインスタンスが作成されていることが分かります。
</p>

<pre>% php AopPrototypeDelegateCilent.php
sum : 0
sum : 0
sum : 0
sum : 0
sum : 0
%
</pre>

委譲したいクラス(Substance)のコンポーネントのinstance属性をsingletonにすると、同一のSubstanceオブジェクトが使用されるためsumの値がインクリメントされます。

<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components21.dtd"&gt;
&lt;components&gt;
    ・・・
    &lt;component name="target" class="Substance" instance="singleton"/&gt;
&lt;/components&gt;</pre>

<pre>% php AopPrototypeDelegateCilent.php
sum : 0
sum : 1
sum : 2
sum : 3
sum : 4
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/delegateinterceptor以下に用意されています。
</p>

<br>
<h3><a name="OriginalInterceptorSample">独自実装によるInterceptor</a></h3>
<p>
　クラス名、メソッド名、引数とメソッドの処理時間を計測してトレースするInterceptorを作成しましょう。また、そのInterceptorを使用して重い処理を行った時間をトレースさせましょう。作成するファイルは以下のとおりです。
</p>

<ul>
    <li type="circle">クラス名、メソッド名、引数とメソッドの処理時間を計測して出力するInterceptor(MeasurementInterceptor.class.php)</li>
    <li type="circle">重い処理を行うクラス(HeavyProces.class.php)</li>
    <li type="circle">コンポーネントの定義を行うdiconファイル(Measurement.dicon)</li>
    <li type="circle">設定が正しく行われているか確認する実行ファイル(AopMeasurementClient.php)</li>
</ul>

<h5>独自実装のIntercepterの作成</h5>

<ul>
    <li type="circle">AbstractInterceptorクラスを実装します。</li>
    <li type="circle">invoke(S2Container_MethodInvocation $invocation)メソッドを実装します。</li>
    <li type="circle">getTargetClass($invocation)->getName()でクラス名を取得します。</li>
    <li type="circle">$invocation->getMethod()->getName()でメソッド名を取得します。</li>
    <li type="circle">$invocation->getArguments()で引数を取得します。</li>
    <li type="circle">$invocation->proceed()で実際のメソッドが呼ばれるので、その前の時間を取得します。</li>
</ul>

<p>　MeasurementInterceptor.class.php</p>
<pre>&lt;?php
class MeasurementInterceptor extends S2Container_AbstractInterceptor {
    public function invoke(S2Container_MethodInvocation $invocation){
        $start = 0;
        $end = 0;
        $buf = "";

        $buf = $this->getTargetClass($invocation)->getName();
        $buf .= "#";
        $buf .= $invocation->getMethod()->getName();
        $buf .= "(";
        $args = $invocation->getArguments();
        $buf .= implode($args) . ")";
        try {
            $start = $this->microtime_float();
            $ret = $invocation->proceed();
            $end = $this->microtime_float();
            $buf .= " : ";
            $t = $end - $start;
            print $buf . $t . "\n";
            return $ret;
        } catch (Exception $t) {
            $buf .= " Exception:";
            $buf .= $t->getMessage();
            throw $t;
        }
    }

    private function microtime_float() {
        list($usec, $sec) = explode(" ", microtime());
        return ((float)$usec + (float)$sec);
    }
}
?&gt;
</pre>

<h5>重い処理を行うクラスの作成</h5>
<ul>
    <li type="circle">重い処理を行ったということにするために5秒間sleepします。</li>
</ul>

<p>　HeavyProcess.class.php</p>

<pre>&lt;?php
class HeavyProcess {
    public function heavy(){
        sleep(5);
    }
}
?&gt;
</pre>

<h5>diconファイルの作成</h5>
<ul>
    <li type="circle">作成したMeasurementInterceptorをコンポーネント定義します。name属性をmeasurementとします。</li>
    <li type="circle">HeavyProcessクラスのheavy()メソッドにMeasurementInterceptorをaspectします。</li>
</ul>
<p>　Measurement.dicon</p>

<pre>&lt;?xml version="1.0" encoding="Shift_JIS"?&gt;
&lt;!DOCTYPE components PUBLIC "-//SEASAR//DTD S2Container//EN"
"http://www.seasar.org/dtd/components32.dtd"&gt;
&lt;components&gt;
    &lt;component name="measurement" class="MeasurementInterceptor"/&gt;
    &lt;component class="HeavyProcess"&gt;
        &lt;aspect pointcut="heavy"&gt;
               measurement
        &lt;/aspect&gt;
    &lt;/component&gt;
&lt;/components&gt;
</pre>

<h5>実行ファイルの作成</h5>
<ul>
    <li type="circle">S2Container#create()メソッドの第１引数に作成したdiconファイル(Measurement.dicon)のパスを指定してコンテナを作成します。</li>
    <li type="circle">S2Container#getComponent()メソッドの第１引数にコンポーネントに登録したクラス名（HeavyProcess)を指定して取得します。</li>
    <li type="circle">コンテナから取得したHeavyProcess#heavy()メソッドを実行します。</li>
</ul>

<p>　AopMeasurementClient.php</p>
<pre>&lt;?php
require_once(dirname(__FILE__) . '/original.inc.php');
$PATH = EXAMPLE_DIR . "/aop/originalinterceptor/Measurement.dicon";

$container = S2ContainerFactory::create($PATH);
$heavyProcess = $container->getComponent('HeavyProcess');
$heavyProcess->heavy();
?&gt;
</pre>

<h5>実行結果</h5>

<p>
　クラス名、メソッド名、引数とメソッドの処理時間がトレースされているのが確認できます。
</p>

<pre>% php AopMeasurementClient.php
HeavyProcess#heavy() : 5.0025010108948
%
</pre>

<p>
このサンプルは、s2container.php5/examples/aop/originalinterceptor以下に用意されています。
</p>

</div>
</div><!-- article -->

</div><!-- contents_center -->

<div id="footer">
<address>&#169; Copyright The Seasar Foundation and the others 2005-2007, all rights reserved.</address>
<div class="line"><span class="hide">spacer</span></div>
</div><!-- footer -->

</div><!-- wrapper -->

</body></html>
